#+title: Custom arch based distribution

* Introduction
This repository installs my custom Arch based distribution on a computer
** What is in this script
- After successful execution, you will be left with a Arch System that contains i3wm
** Prerequisite
- Download an Arch Linux ISO and write it to a USB
- Boot from the live USB and connect to the internet
- From the command line execute following commands
  #+begin_src bash
pacman -Sy archlinux-keyring
pacman -S git
git clone --depth=1 https://github.com/KanishakVaidya/arch-KVOS.git
  #+end_src
- From the ~arch-KVOS~ directory copy all the files to the current directory
- Start by executing the ~base-installation.sh~ script

* Base installation
** Basic setup
#+begin_src bash :tangle base-installation.sh
#!/bin/bash
clear
echo "#############################
This is KV's arch installation script
#############################"

sed -i "s/^#ParallelDownloads = 5$/ParallelDownloads = 5/" /etc/pacman.conf

pacman --noconfirm -Sy archlinux-keyring
loadkeys us
timedatectl set-ntp true
#+end_src
** Partitioning and mounting drives
A good partitioning scheme is as follows:
| Mount point | Partition | Partition type        | Size of partition |
| ----------- | --------- | --------------------- | ----------------- |
| /mnt/boot   | /dev/sda1 | EFI syste partition   | 512 MB            |
| [SWAP]      | /dev/sda2 | Linux swap            | 2x RAM            |
| /mnt        | /dev/sda3 | Linux x86_64 root (/) | Rest of device    |

#+begin_src bash :tangle base-installation.sh
clear ; echo -e "\n\n\n"
lsblk
echo -e "\n\n\n"
read -p "Enter the drive (e.g. /dev/sda or /dev/nvme0n1): " drive
cfdisk $drive

clear ; echo -e "\n\n\n"
lsblk
echo -e "\n\n\n"
read -p "Enter the root partition (e.g. /dev/sda3 or /dev/nvme0n1p3): " partition
mkfs.ext4 $partition
mount $partition /mnt

clear ; echo -e "\n\n\n"
read -p "Create efi partition? [y/n]" efianswer
if [[ $efianswer = y ]] ; then
  lsblk
  echo -e "\n\n\n"
  read -p "Enter EFI partition (e.g. /dev/sda1 or /dev/nvme0n1p1): " efipartition
  mkfs.fat -F 32 $efipartition
  mount --mkdir $efipartition /mnt/boot
fi

clear ; echo -e "\n\n\n"
read -p "Create swap partition? [y/n]" swpanswer
if [[ $swpanswer = y ]] ; then
  lsblk
  echo -e "\n\n\n"
  read -p "Enter EFI partition (e.g. /dev/sda2 or /dev/nvme0n1p2): " swap_partition
  mkswap $swap_partition
  swapon $swap_partition
fi
#+end_src

** Installing base system
Installing
 - base linux system
 - doas for root access
 - nvim text editor
 - a network manager
 - git
#+begin_src bash :tangle base-installation.sh
clear
pacstrap /mnt base linux linux-firmware linux-headers opendoas neovim networkmanager zsh git

clear ; echo -e "\n\n\n Generating fstab \n\n\n"
genfstab -U /mnt >> /mnt/etc/fstab

echo -e "\n\n\n copying configuration script \n\n\n"
cp packages.txt dotfile-setup.sh configuration-script.sh /mnt/

echo "Now chroot into root partition using 'arch-chroot $partition' and run configuration script"
#+end_src
* Configuring the system
This should be run after chrooting into the arch system
** Time zone, Localization and Network configuration
#+begin_src bash :tangle configuration-script.sh
#!/bin/bash
ln -sf /usr/share/zoneinfo/Asia/Kolkata /etc/localtime
hwclock --systohc
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf
echo "KEYMAP=us" > /etc/vconsole.conf
read -p "Hostname: " hostname
echo $hostname > /etc/hostname
echo "127.0.0.1       localhost" >> /etc/hosts
echo "::1             localhost" >> /etc/hosts
echo "127.0.1.1       $hostname.localdomain $hostname" >> /etc/hosts
#+end_src
** Users and passwords
#+begin_src bash :tangle configuration-script.sh
clear ; echo -e "\n\n\n Setting Root Password \n\n\n"
passwd

echo -e "\n\n\n Setting up a user \n\n\n"
read -p "Enter a username: " username
useradd -m -G audio,video,storage,optical,wheel -s /usr/bin/zsh $username
passwd $username
echo "permit persist :wheel as root" > /etc/doas.conf
echo 'export ZDOTDIR="$HOME"/.config/zsh' > /etc/zsh/zshenv
#+end_src

** Grub configuration and startup daemons
#+begin_src bash :tangle configuration-script.sh
pacman --noconfirm -S sed
sed -i "s/^#ParallelDownloads = 5$/ParallelDownloads = 5/" /etc/pacman.conf

pacman --noconfirm -S grub efibootmgr os-prober
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=myArch
grub-mkconfig -o /boot/grub/grub.cfg

systemctl enable NetworkManager.service

mv dotfile-setup.sh packages.txt /home/$username

echo "Now you can exit out of the chrooted environment. Unmount the drives mounted in /mnt and reboot."
#+end_src
* dotfiles setup
** Setting variables and links
#+begin_src bash :tangle dotfile-setup.sh
echo "setting a link to doas"
doas ln -sf /bin/doas /bin/sudo
echo "setting a link to xresources"
ln -sf ~/.config/Xresources/codedark ~/.Xresources
mkdir -p $HOME/desktop $HOME/dwn $HOME/templates $HOME/shared $HOME/doc $HOME/music $HOME/pic $HOME/vid $HOME/.local/state/zsh $HOME/.local/share $HOME/.local/bin
doas pacman --noconfirm -S xdg-user-dirs rsync
xdg-user-dirs-update
#+end_src
** Bringing dotfiles from github
Managing dotfiles using a git bare repository is referenced from [[https://www.anand-iyer.com/blog/2018/a-simpler-way-to-manage-your-dotfiles.html][this Anand Iyer's blog]]
#+begin_src bash :tangle dotfile-setup.sh
git clone --depth=1 --separate-git-dir=$HOME/.config/my_dotfiles https://github.com/KanishakVaidya/dotfiles.git /tmp/tmpdotfiles
rsync --recursive --verbose --exclude '.git' /tmp/tmpdotfiles/ $HOME/
#+end_src
** Installing icons and themes
Installing [[https://github.com/PapirusDevelopmentTeam/papirus-icon-theme.git][papirus icons]] and materia dark theme
#+begin_src bash
git clone --depth=1 https://github.com/PapirusDevelopmentTeam/papirus-icon-theme.git /tmp/papirus-icons
mkdir -p $HOME/.local/share/icons
cp -r /tmp/papirus-icons/Papirus* $HOME/.local/share/icons/
#+end_src
** Installing all the packages
#+begin_src bash :tangle dotfile-setup.sh
#!/bin/bash

echo "
#######################
Installing the packages
#######################
"

doas pacman --needed -Syu $(cat packages.txt)
#+end_src
